<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>隐语义协同过滤推荐 | 课程概述</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../4-实时推荐/index.html" />
    
    
    <link rel="prev" href="../3-离线推荐/3-基于内容推荐.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="3.4"
        data-chapter-title="隐语义协同过滤推荐"
        data-filepath="3-离线推荐/4-基于隐语义协同过滤推荐.md"
        data-basepath=".."
        data-revision="Wed Feb 19 2020 15:25:54 GMT+0800 (CST)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="1-项目搭建/index.html">
            
                
                    <a href="../1-项目搭建/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        推荐系统项目
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="1-项目搭建/1-项目介绍.html">
            
                
                    <a href="../1-项目搭建/1-项目介绍.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        项目搭建
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="1-项目搭建/2-数据介绍.html">
            
                
                    <a href="../1-项目搭建/2-数据介绍.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        数据介绍
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="2-加载数据/index.html">
            
                
                    <a href="../2-加载数据/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        加载数据
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="2-加载数据/1-项目搭建.html">
            
                
                    <a href="../2-加载数据/1-项目搭建.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        创建项目
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="2-加载数据/2-读取数据.html">
            
                
                    <a href="../2-加载数据/2-读取数据.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        读取数据
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="3-离线推荐/index.html">
            
                
                    <a href="../3-离线推荐/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        离线推荐
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="3-离线推荐/1-添加业务系统.html">
            
                
                    <a href="../3-离线推荐/1-添加业务系统.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        添加业务系统
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="3-离线推荐/2-统计推荐.html">
            
                
                    <a href="../3-离线推荐/2-统计推荐.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        统计推荐
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="3-离线推荐/3-基于内容推荐.html">
            
                
                    <a href="../3-离线推荐/3-基于内容推荐.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        基于内容推荐
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="3.4" data-path="3-离线推荐/4-基于隐语义协同过滤推荐.html">
            
                
                    <a href="../3-离线推荐/4-基于隐语义协同过滤推荐.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        隐语义协同过滤推荐
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="4-实时推荐/index.html">
            
                
                    <a href="../4-实时推荐/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        实时推荐
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="4-实时推荐/1-实时推荐服务建设.html">
            
                
                    <a href="../4-实时推荐/1-实时推荐服务建设.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        实时推荐服务建设
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="4-实时推荐/2-实时系统联调.html">
            
                
                    <a href="../4-实时推荐/2-实时系统联调.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        实时推荐联调
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >课程概述</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="&#x534F;&#x540C;&#x8FC7;&#x6EE4;&#x63A8;&#x8350;cf">&#x534F;&#x540C;&#x8FC7;&#x6EE4;&#x63A8;&#x8350;(CF)</h1>
<p><strong>&#x901A;&#x8FC7; ALS &#x8BAD;&#x7EC3;&#x51FA;&#x6765;&#x7684; Model &#x6765;&#x8BA1;&#x7B97;&#x6240;&#x6709;&#x5F53;&#x524D;&#x7528;&#x6237;&#x7535;&#x5F71;&#x7684;&#x63A8;&#x8350;&#x77E9;&#x9635;&#xFF0C;&#x4E3B;&#x8981;&#x601D;&#x8DEF;&#x5982;&#x4E0B;:</strong></p>
<ol>
<li>UserId &#x548C; MovieID &#x505A;&#x7B1B;&#x5361;&#x5C14;&#x79EF;&#xFF0C;&#x4EA7;&#x751F;(uid&#xFF0C;mid)&#x77E9;&#x9635; (&#x7A7A;&#x77E9;&#x9635;)</li>
<li>&#x901A;&#x8FC7;&#x6A21;&#x578B;&#x9884;&#x6D4B;(uid&#xFF0C;mid)&#x7684;&#x5143;&#x7EC4;&#x3002;</li>
<li>&#x5C06;&#x9884;&#x6D4B;&#x7ED3;&#x679C;&#x901A;&#x8FC7;&#x9884;&#x6D4B;&#x5206;&#x503C;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x3002;</li>
<li>&#x8FD4;&#x56DE;&#x5206;&#x503C;&#x6700;&#x5927;&#x7684; K &#x4E2A;&#x7535;&#x5F71;&#xFF0C;&#x4F5C;&#x4E3A;&#x5F53;&#x524D;&#x7528;&#x6237;&#x7684;&#x63A8;&#x8350;&#x3002;</li>
</ol>
<p><strong>&#x6700;&#x540E;&#x751F;&#x6210;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5982;&#x4E0B;: &#x5C06;&#x6570;&#x636E;&#x4FDD;&#x5B58;&#x5230;MongoDB&#x7684;UserRecs&#x8868;&#x4E2D;</strong></p>
<p><img src="http://kflys.gitee.io/upic/2020/03/22/uPic/movierecommender/image-20191226150620051.png" alt="image-20191226150620051"></p>
<h3 id="2-&#x4EE3;&#x7801;&#x5B9E;&#x73B0;">2. &#x4EE3;&#x7801;&#x5B9E;&#x73B0;</h3>
<h4 id="21-&#x65B0;&#x5EFA;-recommender-&#x7684;&#x5B50;&#x9879;&#x76EE;-offlinerecommender&#xFF0C;&#x5F15;&#x5165;-spark&#x3001;scala&#x3001;mongo-&#x548C;-jblas-&#x7684;&#x4F9D;&#x8D56;">2.1 &#x65B0;&#x5EFA; recommender &#x7684;&#x5B50;&#x9879;&#x76EE; OfflineRecommender&#xFF0C;&#x5F15;&#x5165; spark&#x3001;scala&#x3001;mongo &#x548C; jblas &#x7684;&#x4F9D;&#x8D56;:</h4>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-title">dependencies</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>org.scalanlp<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>jblas<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>${jblas.version}<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Spark&#x7684;&#x4F9D;&#x8D56;&#x5F15;&#x5165; --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>org.apache.spark<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>spark-core_2.11<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>org.apache.spark<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>spark-sql_2.11<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>org.apache.spark<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>spark-mllib_2.11<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- &#x5F15;&#x5165;Scala --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>org.scala-lang<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>scala-library<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- &#x52A0;&#x5165;MongoDB&#x7684;&#x9A71;&#x52A8; --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>org.mongodb<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>casbah-core_2.11<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>${casbah.version}<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>org.mongodb.spark<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>mongo-spark-connector_2.11<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>${mongodb-spark.version}<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">dependencies</span>&gt;</span>
</code></pre>
<h3 id="3-&#x52A0;&#x8F7D;&#x6570;&#x636E;&#x8BA1;&#x7B97;&#x6A21;&#x578B;">3. &#x52A0;&#x8F7D;&#x6570;&#x636E;&#x8BA1;&#x7B97;&#x6A21;&#x578B;</h3>
<blockquote>
<p>&#x540C;&#x6837;&#x7ECF;&#x8FC7;&#x524D;&#x671F;&#x7684;&#x6784;&#x5EFA;&#x6837;&#x4F8B;&#x7C7B;&#x3001;&#x58F0;&#x660E;&#x914D;&#x7F6E;&#x3001;&#x521B;&#x5EFA; SparkSession &#x7B49;&#x6B65;&#x9AA4;&#xFF0C;&#x53EF;&#x4EE5;&#x52A0;&#x8F7D; &#x6570;&#x636E;&#x5F00;&#x59CB;&#x8BA1;&#x7B97;&#x6A21;&#x578B;&#x4E86;&#x3002;</p>
</blockquote>
<p><strong>src/main/scala/com.kkb.offline/OfflineRecommender.scala</strong></p>
<pre><code class="lang-scala"><span class="hljs-keyword">package</span> com.kkb.offline
<span class="hljs-keyword">import</span> org.apache.spark.<span class="hljs-type">SparkConf</span>
<span class="hljs-keyword">import</span> org.apache.spark.mllib.recommendation.{<span class="hljs-type">ALS</span>, <span class="hljs-type">Rating</span>}
<span class="hljs-keyword">import</span> org.apache.spark.sql.<span class="hljs-type">SparkSession</span>
<span class="hljs-keyword">import</span> org.jblas.<span class="hljs-type">DoubleMatrix</span>

<span class="hljs-comment">// &#x57FA;&#x4E8E;&#x8BC4;&#x5206;&#x6570;&#x636E;&#x7684;LFM&#xFF0C;&#x53EA;&#x9700;&#x8981;rating&#x6570;&#x636E;</span>
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MovieRating</span>(</span>uid: <span class="hljs-type">Int</span>, mid: <span class="hljs-type">Int</span>, score: <span class="hljs-type">Double</span>, timestamp: <span class="hljs-type">Int</span> )
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MongoConfig</span>(</span>uri:<span class="hljs-type">String</span>, db:<span class="hljs-type">String</span>)
<span class="hljs-comment">// &#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x57FA;&#x51C6;&#x63A8;&#x8350;&#x5BF9;&#x8C61;</span>
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Recommendation</span>(</span> mid: <span class="hljs-type">Int</span>, score: <span class="hljs-type">Double</span> )
<span class="hljs-comment">// &#x5B9A;&#x4E49;&#x57FA;&#x4E8E;&#x9884;&#x6D4B;&#x8BC4;&#x5206;&#x7684;&#x7528;&#x6237;&#x63A8;&#x8350;&#x5217;&#x8868;</span>
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRecs</span>(</span> uid: <span class="hljs-type">Int</span>, recs: <span class="hljs-type">Seq</span>[<span class="hljs-type">Recommendation</span>] )
<span class="hljs-comment">// &#x5B9A;&#x4E49;&#x57FA;&#x4E8E;LFM&#x7535;&#x5F71;&#x7279;&#x5F81;&#x5411;&#x91CF;&#x7684;&#x7535;&#x5F71;&#x76F8;&#x4F3C;&#x5EA6;&#x5217;&#x8868;</span>
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MovieRecs</span>(</span> mid: <span class="hljs-type">Int</span>, recs: <span class="hljs-type">Seq</span>[<span class="hljs-type">Recommendation</span>] )

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">OfflineRecommender</span> {</span>
  <span class="hljs-comment">// &#x5B9A;&#x4E49;&#x8868;&#x540D;&#x548C;&#x5E38;&#x91CF;</span>
  <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">MONGODB_RATING_COLLECTION</span> =</span> <span class="hljs-string">&quot;Rating&quot;</span>
  <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">USER_RECS</span> =</span> <span class="hljs-string">&quot;UserRecs&quot;</span>
  <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">MOVIE_RECS</span> =</span> <span class="hljs-string">&quot;MovieRecs&quot;</span>
  <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">USER_MAX_RECOMMENDATION</span> =</span> <span class="hljs-number">20</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>(</span>args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">config</span> =</span> <span class="hljs-type">Map</span>(
      <span class="hljs-string">&quot;spark.cores&quot;</span> -&gt; <span class="hljs-string">&quot;local[*]&quot;</span>,
      <span class="hljs-string">&quot;mongo.uri&quot;</span> -&gt; <span class="hljs-string">&quot;mongodb://cdh1:27017/recommender&quot;</span>,
      <span class="hljs-string">&quot;mongo.db&quot;</span> -&gt; <span class="hljs-string">&quot;recommender&quot;</span>
    )

    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">sparkConf</span> =</span> <span class="hljs-keyword">new</span> <span class="hljs-type">SparkConf</span>().setMaster(config(<span class="hljs-string">&quot;spark.cores&quot;</span>)).setAppName(<span class="hljs-string">&quot;OfflineRecommender&quot;</span>)

    <span class="hljs-comment">// &#x521B;&#x5EFA;&#x4E00;&#x4E2A;SparkSession</span>
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">spark</span> =</span> <span class="hljs-type">SparkSession</span>.builder().config(sparkConf).getOrCreate()

    <span class="hljs-keyword">import</span> spark.implicits._

    <span class="hljs-keyword">implicit</span> <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">mongoConfig</span> =</span> <span class="hljs-type">MongoConfig</span>(config(<span class="hljs-string">&quot;mongo.uri&quot;</span>), config(<span class="hljs-string">&quot;mongo.db&quot;</span>))


    <span class="hljs-comment">// &#x52A0;&#x8F7D;&#x6570;&#x636E;</span>
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">ratingRDD</span> =</span> spark.read
      .option(<span class="hljs-string">&quot;uri&quot;</span>, mongoConfig.uri)
      .option(<span class="hljs-string">&quot;collection&quot;</span>, <span class="hljs-type">MONGODB_RATING_COLLECTION</span>)
      .format(<span class="hljs-string">&quot;com.mongodb.spark.sql&quot;</span>)
      .load()
      .as[<span class="hljs-type">MovieRating</span>]
      .rdd
      .map( rating =&gt; ( rating.uid, rating.mid, rating.score ) )    <span class="hljs-comment">// &#x8F6C;&#x5316;&#x6210;rdd&#xFF0C;&#x5E76;&#x4E14;&#x53BB;&#x6389;&#x65F6;&#x95F4;&#x6233;</span>
      .cache()

    <span class="hljs-comment">// &#x8BAD;&#x7EC3;&#x9690;&#x8BED;&#x4E49;&#x6A21;&#x578B;</span>
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">trainData</span> =</span> ratingRDD.map( x =&gt; <span class="hljs-type">Rating</span>(x._1, x._2, x._3) )

    <span class="hljs-function"><span class="hljs-keyword">val</span> (</span>rank, iterations, lambda) = (<span class="hljs-number">200</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0.05</span>)
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">model</span> =</span> <span class="hljs-type">ALS</span>.train(trainData, rank, iterations, lambda)
    println(<span class="hljs-string">&quot;++++++++++++++++++++++++++++&quot;</span>)

    <span class="hljs-comment">// &#x4ECE;rating&#x6570;&#x636E;&#x4E2D;&#x63D0;&#x53D6;&#x6240;&#x6709;&#x7684;uid&#x548C;mid&#xFF0C;&#x5E76;&#x53BB;&#x91CD;</span>
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">userRDD</span> =</span> ratingRDD.map(_._1).distinct()
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">movieRDD</span> =</span> ratingRDD.map(_._2).distinct()

    <span class="hljs-comment">// &#x57FA;&#x4E8E;&#x7528;&#x6237;&#x548C;&#x7535;&#x5F71;&#x7684;&#x9690;&#x7279;&#x5F81;&#xFF0C;&#x8BA1;&#x7B97;&#x9884;&#x6D4B;&#x8BC4;&#x5206;&#xFF0C;&#x5F97;&#x5230;&#x7528;&#x6237;&#x7684;&#x63A8;&#x8350;&#x5217;&#x8868;</span>
    <span class="hljs-comment">// &#x8BA1;&#x7B97;user&#x548C;movie&#x7684;&#x7B1B;&#x5361;&#x5C14;&#x79EF;&#xFF0C;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x7A7A;&#x8BC4;&#x5206;&#x77E9;&#x9635;</span>
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">userMovies</span> =</span> userRDD.cartesian(movieRDD)

    <span class="hljs-comment">// &#x8C03;&#x7528;model&#x7684;predict&#x65B9;&#x6CD5;&#x9884;&#x6D4B;&#x8BC4;&#x5206;</span>
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">preRatings</span> =</span> model.predict(userMovies)

    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">userRecs</span> =</span> preRatings
      .filter(_.rating &gt; <span class="hljs-number">0</span>)    <span class="hljs-comment">// &#x8FC7;&#x6EE4;&#x51FA;&#x8BC4;&#x5206;&#x5927;&#x4E8E;0&#x7684;&#x9879;</span>
      .map(rating =&gt; ( rating.user, (rating.product, rating.rating) ) )
      .groupByKey()
      .map{
        <span class="hljs-keyword">case</span> (uid, recs) =&gt; <span class="hljs-type">UserRecs</span>( uid, recs.toList.sortWith(_._2&gt;_._2).take(<span class="hljs-type">USER_MAX_RECOMMENDATION</span>).map(x=&gt;<span class="hljs-type">Recommendation</span>(x._1, x._2)) )
      }
      .toDF()

    println(<span class="hljs-string">&quot;++++++++++++++++++++++++++++&quot;</span>)
    userRecs.write
      .option(<span class="hljs-string">&quot;uri&quot;</span>, mongoConfig.uri)
      .option(<span class="hljs-string">&quot;collection&quot;</span>, <span class="hljs-type">USER_RECS</span>)
      .mode(<span class="hljs-string">&quot;overwrite&quot;</span>)
      .format(<span class="hljs-string">&quot;com.mongodb.spark.sql&quot;</span>)
      .save()

    <span class="hljs-comment">// &#x57FA;&#x4E8E;&#x7535;&#x5F71;&#x9690;&#x7279;&#x5F81;&#xFF0C;&#x8BA1;&#x7B97;&#x76F8;&#x4F3C;&#x5EA6;&#x77E9;&#x9635;&#xFF0C;&#x5F97;&#x5230;&#x7535;&#x5F71;&#x7684;&#x76F8;&#x4F3C;&#x5EA6;&#x5217;&#x8868;</span>
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">movieFeatures</span> =</span> model.productFeatures.map{
      <span class="hljs-keyword">case</span> (mid, features) =&gt; (mid, <span class="hljs-keyword">new</span> <span class="hljs-type">DoubleMatrix</span>(features))
    }

    <span class="hljs-comment">// &#x5BF9;&#x6240;&#x6709;&#x7535;&#x5F71;&#x4E24;&#x4E24;&#x8BA1;&#x7B97;&#x5B83;&#x4EEC;&#x7684;&#x76F8;&#x4F3C;&#x5EA6;&#xFF0C;&#x5148;&#x505A;&#x7B1B;&#x5361;&#x5C14;&#x79EF;</span>
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">movieRecs</span> =</span> movieFeatures.cartesian(movieFeatures)
      .filter{
        <span class="hljs-comment">// &#x628A;&#x81EA;&#x5DF1;&#x8DDF;&#x81EA;&#x5DF1;&#x7684;&#x914D;&#x5BF9;&#x8FC7;&#x6EE4;&#x6389;</span>
        <span class="hljs-keyword">case</span> (a, b) =&gt; a._1 != b._1
      }
      .map{
        <span class="hljs-keyword">case</span> (a, b) =&gt; {
          <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">simScore</span> =</span> <span class="hljs-keyword">this</span>.consinSim(a._2, b._2)
          ( a._1, ( b._1, simScore ) )
        }
      }
      .filter(_._2._2 &gt; <span class="hljs-number">0.6</span>)    <span class="hljs-comment">// &#x8FC7;&#x6EE4;&#x51FA;&#x76F8;&#x4F3C;&#x5EA6;&#x5927;&#x4E8E;0.6&#x7684;</span>
      .groupByKey()
      .map{
        <span class="hljs-keyword">case</span> (mid, items) =&gt; <span class="hljs-type">MovieRecs</span>( mid, items.toList.sortWith(_._2 &gt; _._2).map(x =&gt; <span class="hljs-type">Recommendation</span>(x._1, x._2)) )
      }
      .toDF()
    println(movieRecs, <span class="hljs-string">&quot;++++++++++++++++++++++++++++&quot;</span>)
    movieRecs.write
      .option(<span class="hljs-string">&quot;uri&quot;</span>, mongoConfig.uri)
      .option(<span class="hljs-string">&quot;collection&quot;</span>, <span class="hljs-type">MOVIE_RECS</span>)
      .mode(<span class="hljs-string">&quot;overwrite&quot;</span>)
      .format(<span class="hljs-string">&quot;com.mongodb.spark.sql&quot;</span>)
      .save()
    spark.stop()
  }

  <span class="hljs-comment">// &#x6C42;&#x5411;&#x91CF;&#x4F59;&#x5F26;&#x76F8;&#x4F3C;&#x5EA6;</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">consinSim</span>(</span>movie1: <span class="hljs-type">DoubleMatrix</span>, movie2: <span class="hljs-type">DoubleMatrix</span>):<span class="hljs-type">Double</span> ={
    movie1.dot(movie2) / ( movie1.norm2() * movie2.norm2() )
  }
}
</code></pre>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../3-离线推荐/3-基于内容推荐.html" class="navigation navigation-prev " aria-label="Previous page: 基于内容推荐"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../4-实时推荐/index.html" class="navigation navigation-next " aria-label="Next page: 实时推荐"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
